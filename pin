from fastapi import FastAPI, HTTPException
from fastapi.middleware.cors import CORSMiddleware
from fastapi.responses import StreamingResponse
import uvicorn
import json
from pydantic import BaseModel
from typing import List, Optional

# Import your FlightOpsMCPClient (assuming it's defined elsewhere)
# from your_module import FlightOpsMCPClient

app = FastAPI(title="FlightOps AG-UI Server")

# CORS middleware
app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:5173", "http://127.0.0.1:5173"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

class Message(BaseModel):
    id: str
    role: str
    content: str

class AgentRequest(BaseModel):
    thread_id: str
    run_id: str
    messages: List[Message]
    tools: List[str]

@app.get("/")
async def root():
    return {"message": "FlightOps AG-UI Server is running"}

@app.post("/agent")
async def agent_endpoint(request: AgentRequest):
    try:
        # Get the last user message
        user_messages = [msg for msg in request.messages if msg.role == "user"]
        if not user_messages:
            raise HTTPException(status_code=400, detail="No user message found")

        user_query = user_messages[-1].content
        print(f"üì• Processing query: {user_query}")

        # Initialize client and run query
        # Note: You'll need to import or define FlightOpsMCPClient
        client = FlightOpsMCPClient()
        
        async def generate():
            try:
                result = await client.run_query(user_query)
                
                # Start message
                yield f"data: {json.dumps({'type': 'TEXT_MESSAGE_START', 'message_id': request.run_id})}\n\n"
                
                # Stream content
                summary = result.get('summary', {}).get('summary', 'No summary available')
                yield f"data: {json.dumps({'type': 'TEXT_MESSAGE_CONTENT', 'delta': summary})}\n\n"
                
                # End message
                yield f"data: {json.dumps({'type': 'TEXT_MESSAGE_END', 'message_id': request.run_id})}\n\n"
                
            except Exception as e:
                error_msg = f"Error processing query: {str(e)}"
                yield f"data: {json.dumps({'type': 'RUN_ERROR', 'message': error_msg})}\n\n"
            finally:
                await client.disconnect()

        return StreamingResponse(
            generate(),
            media_type="text/event-stream",
            headers={
                "Cache-Control": "no-cache",
                "Connection": "keep-alive",
                "Access-Control-Allow-Origin": "*",
                "Access-Control-Allow-Headers": "*",
            }
        )

    except Exception as e:
        print(f"‚ùå Error in agent endpoint: {e}")
        raise HTTPException(status_code=500, detail=str(e))

if __name__ == "__main__":
    print("üöÄ Starting FlightOps AG-UI Server...")
    uvicorn.run(app, host="0.0.0.0", port=8001)
